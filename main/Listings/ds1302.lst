C51 COMPILER V9.54   DS1302                                                                05/10/2019 14:59:31 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\Objects\ds1302.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE ..\ds1302\ds1302.c OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(..\delay;..\ds18
                    -b20;..\lcd12864;..\ds1302) DEBUG PRINT(.\Listings\ds1302.lst) OBJECT(.\Objects\ds1302.obj)

line level    source

   1          #include <reg52.h>
   2          #include <INTRINS.H> //用到_nop_()必须包含的头文件
   3          #include "typedef.h"
   4          #include "ds1302.h"
   5          #include "delay.h"
   6          
   7          //********************************************************************************************************
             -**********************
   8          //IO设置
   9          //********************************************************************************************************
             -**********************
  10                  //sbit RST=P2^5;  //输入信号引脚，读写数据期间必须为高
  11                  //sbit SCLK=P2^6; //串行时钟，控制数据的输入与输出
  12                  //sbit IO=P2^7;   //双向数据线
  13          
  14                  sbit RST=P1^0;  //输入信号引脚，读写数据期间必须为高
  15                  sbit SCLK=P1^1; //串行时钟，控制数据的输入与输出
  16                  sbit IO=P1^2;   //双向数据线
  17          
  18          //********************************************************************************************************
             -**********************
  19          //申请空间
  20          //********************************************************************************************************
             -**********************
  21                  extern uchar time[];
  22                  extern uchar date[];
  23          
  24          //********************************************************************************************************
             -**********************
  25          //写指令
  26          //********************************************************************************************************
             -**********************
  27          uchar Ds1302_Read_Data(uchar cmd)//cmd为命令字
  28          {
  29   1              uchar i,tempbit,tempdata;//保存临时时位，tempdata保存临时数据
  30   1              RST=0; //启动读写之前低电平
  31   1              SCLK=0; //启动读写之前低电平
  32   1              RST=1;  //置高电平，准备读写
  33   1              for(i=0;i<8;i++)
  34   1              {  //注意，该循环开始时SCLK为低电平
  35   2                      if(cmd&0x01) //数据的发送从最低位开始，这里是提取最低位
  36   2                              IO=1;                   //如果cmd&0x01为真，说明最低位为1
  37   2                      else
  38   2                              IO=0;                           //为假说明最低位为0，送最低位上的数据总线
  39   2                              cmd=cmd>>1;             //右移一位，下一个上升沿送上总线
  40   2                              SCLK=1;   //产生一次上升沿，在这个上升沿DS1302采样总线上的数据
  41   2                              _nop_();
  42   2                              SCLK=0;    //拉低SCLK，为制造下个上升沿做准备
  43   2              }
  44   1      //读出数据，低位开始。下降沿读出
  45   1                      for(i=0;i<8;i++) 
  46   1                      {
  47   2              /*注意，上一循环的最后有一个下降沿，该下降沿使得DS1302已经送?位数据上总线，所以一开始就直接读 */
  48   2                              if(IO==1)  //如果总线是高电平，说明DS1302送的数据是1
C51 COMPILER V9.54   DS1302                                                                05/10/2019 14:59:31 PAGE 2   

  49   2                                      tempbit=0x80; //置tempbit的最高位位1，相当于读取了I/O上的数据
  50   2                              else
  51   2                                      tempbit=0;
  52   2                                      tempdata=tempdata>>1|tempbit;//将获得的位整合进tempdata
  53   2                                      SCLK=1; //拉高电平，为产生下个下降沿做准备
  54   2                                      _nop_();
  55   2                                      SCLK=0;//产生   下降沿,DS1302将下一位数据送上总线。
  56   2                      }
  57   1              RST=0;
  58   1              return tempdata;
  59   1      }
  60          
  61          //********************************************************************************************************
             -**************************************************
  62          //写数据
  63          //********************************************************************************************************
             -**************************************************
  64          void Ds1302_Write_Data(uchar cmd, uchar dat)
  65          {
  66   1              uchar i;
  67   1              RST=0;
  68   1              SCLK=0;
  69   1              RST=1;
  70   1              for(i=0;i<8;i++)
  71   1              {
  72   2                      if(cmd&0x01)
  73   2                              IO=1;
  74   2                      else
  75   2                              IO=0;
  76   2                              cmd=cmd>>1;
  77   2                              SCLK=1;
  78   2                              _nop_();
  79   2                              SCLK=0;
  80   2              }
  81   1              for(i=0;i<8;i++)  //写入数据到DS1302,上升沿写入
  82   1              {
  83   2                      if(dat&0x01)
  84   2                              IO=1;
  85   2                      else
  86   2                              IO=0;
  87   2                              dat=dat>>1;
  88   2                              SCLK=1;//与前一循环中的最后的低电平结合产生一个上升沿
  89   2                              _nop_();
  90   2                              SCLK=0;
  91   2              }
  92   1              RST=0;
  93   1      }
  94          
  95          //********************************************************************************************************
             -**********************
  96          //初始化
  97          //********************************************************************************************************
             -**********************
  98          void Ds1302_Init()//对DS1302进行初始化，设置开始时间
  99          {
 100   1              Ds1302_Write_Data(0x8e,0x00);//将写保护关闭，允许对DS1302进行写操作
 101   1              
 102   1              Ds1302_Write_Data(0x80,0x24);//设置秒寄存器的初始值是24秒
 103   1              Ds1302_Write_Data(0x82,0x57);//设置分寄存器的初始值是57分
 104   1              Ds1302_Write_Data(0x84,0x20);//设置小时寄存器的初始值是18时
 105   1      
 106   1              Ds1302_Write_Data(0x86,0x01);//设置日寄存器的初始值是1
C51 COMPILER V9.54   DS1302                                                                05/10/2019 14:59:31 PAGE 3   

 107   1              Ds1302_Write_Data(0x88,0x12);//设置月寄存器的初始值是12
 108   1              Ds1302_Write_Data(0x8A,0x04);//设置周寄存器的初始值是1
 109   1              Ds1302_Write_Data(0x8c,0x15);//设置年寄存器的初始值是15
 110   1      
 111   1              Ds1302_Write_Data(0x8e,0x80);//打开写保护，禁止往DS1302写入数据
 112   1      }
 113          
 114          //********************************************************************************************************
             -**********************
 115          //读时间
 116          //********************************************************************************************************
             -**********************
 117          void Ds1302_Read_Time()
 118          {
 119   1              uchar Second,Minute,Hour;
 120   1              uchar Year,Month,Date,Week;
 121   1              Second=Ds1302_Read_Data(0x81);//将秒寄存器的内容读到Second
 122   1              Minute=Ds1302_Read_Data(0x83);//将分寄存器的内容读到Minute
 123   1              Hour=Ds1302_Read_Data(0x85);//将小时寄存器的内容读到Hour
 124   1      
 125   1              Date=Ds1302_Read_Data(0x87);//将日寄存器的内容读到Date
 126   1              Month=Ds1302_Read_Data(0x89);//将月寄存器的内容读到Month
 127   1              Week=Ds1302_Read_Data(0x8b);//将周的寄存器的内容读到Week
 128   1              Year=Ds1302_Read_Data(0x8d);//将年的寄存器的内容读到Year
 129   1      
 130   1              time[6]=(Second>>4)+'0';//将秒的低四位（十位）转为字符
 131   1              time[7]=(Second&0x0f)+'0';//将秒的高四位（个位）转为字符
 132   1              time[3]=(Minute>>4)+'0';//将分的低四位（十位）转为字符
 133   1              time[4]=(Minute&0x0f)+'0';//将分的高四位（个位）转为字符
 134   1              time[0]=(Hour>>4)+'0';//小时的十位
 135   1              time[1]=(Hour&0x0f)+'0';//小时的个位
 136   1              
 137   1              date[6]=(Date>>4)+'0';//日期的十位
 138   1              date[7]=(Date&0x0f)+'0';//日期的个位
 139   1              date[3]=(Month>>4)+'0';//月的十位
 140   1              date[4]=(Month&0x0f)+'0';//月的个位
 141   1              date[0]=(Year>>4)+'0';//年的十位
 142   1              date[1]=(Year&0x0f)+'0';//年的个位
 143   1      
 144   1              date[9]=(Week&0x0f)+'0';
 145   1      }
 146          
 147          
 148          
 149          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    333    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
